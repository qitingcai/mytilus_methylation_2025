### Aim of this script: make bar plots that shows the proportion of CpGs or DM CpGs that fall into each genomic feature ###
### Run Fisher's exact tests to compare distribution of each genomic feature within tissues, and to compare log2FC of DM CpGs between tissue types for each treatment ###

dm_bar_plot<-read_csv("/Users/qcai/Documents/UCSC/Kelley_Lab/mytilus/manuscript/fisher_test_input_final.csv")

dm_bar_plot<- dm_bar_plot %>% 
  mutate(nonDM=Total-DM_count)

# Define custom colors (feature = color)
custom_colors <- c(
  "Intron" = "#0662AE",
  "Exon" = "#ABCDE9",
  "Promoter" = "#1F3161",
  "Intergenic" = "#3792D0",
  "UTR"="#d8e0e6"
)

library("ggthemes")
library(dplyr)


# Create a new row for the "Total" feature in each group
total_bars <- dm_bar_plot %>%
  group_by(Type, tissue) %>%
  summarise(
    DM_count = sum(DM_count),
    nonDM_count = sum(nonDM_count),
    Total = sum(Total),
    .groups = "drop"
  ) %>%
  mutate(
    feature = "Total",
    DM_proportion = DM_count / Total,
    non_DM_proportion = nonDM_count / Total
  )


# Create a new row for the "Total" feature in each group
total_bars <- dm_bar_plot %>%
  group_by(Type, tissue) %>%
  summarise(
    DM_count = sum(DM_count),
    nonDM_count = sum(nonDM_count),
    Total = sum(Total),
    .groups = "drop"
  ) %>%
  mutate(
    feature = "Total",
    DM_proportion = DM_count / Total,
    non_DM_proportion = nonDM_count / Total
  )

library(dplyr)
library(tidyr)

## 1) Per tissue × Type × feature (counts + proportions)
tbl_type <- dm_bar_plot %>%
  group_by(tissue, Type, feature) %>%
  summarise(
    DM_count    = sum(DM_count),
    nonDM_count = sum(nonDM_count),
    Total       = sum(Total),
    .groups = "drop"
  ) %>%
  mutate(
    DM_proportion     = DM_count / Total,
    non_DM_proportion = nonDM_count / Total
  )

## 2) Add a combined "Total" (Origin+Transplant) per tissue × feature
tbl_total <- dm_bar_plot %>%
  group_by(tissue, feature) %>%
  summarise(
    DM_count    = sum(DM_count),
    nonDM_count = sum(nonDM_count),
    Total       = sum(Total),
    .groups = "drop"
  ) %>%
  mutate(
    Type              = "Total",
    DM_proportion     = DM_count / Total,
    non_DM_proportion = nonDM_count / Total
  ) %>%
  select(names(tbl_type))  # same column order

## 3) Final table (Origin, Transplant, then Total)
summary_tbl <- bind_rows(tbl_type, tbl_total) %>%
  mutate(Type = factor(Type, levels = c("Origin", "Transplant", "Total"))) %>%
  arrange(tissue, Type, feature)

summary_tbl

# Separated origin and transplant tissues 

origin_tissues<- dm_bar_plot %>% 
  filter(Type =="Origin")
transplant_tissues<- dm_bar_plot %>% 
  filter(Type =="Transplant")

# to look at overall distribution and whether the patterns differ between tissue combined
table_data_origin <- xtabs(DM_count ~ feature + tissue, data = origin_tissues)
fisher.test(table_data_origin)

table_data_trans <- xtabs(DM_count ~ feature + tissue, data = transplant_tissues)
fisher.test(table_data_trans)

library(dplyr)


# Transplant site comparing distribution of each feature vs. all other features in foot and gills

features_trans <- rownames(table_data_trans)
results <- lapply(features_trans, function(f) {
  # rows to use for "all other features"
  others <- setdiff(features_trans, f)
  
  feature_vs_rest <- rbind(
    Feature    = table_data_trans[f, , drop = FALSE],
    All_others = colSums(table_data_trans[others, , drop = FALSE])
  )
  
  test <- fisher.test(feature_vs_rest)  # works if there are exactly 2 columns
  
  data.frame(
    feature    = f,
    odds_ratio = if (!is.null(test$estimate)) unname(test$estimate) else NA_real_,
    p_value    = test$p.value,
    row.names  = NULL
  )
})
results_df <- bind_rows(results)
results_df <- results_df %>%
  mutate(p_adj = p.adjust(p_value, method = "BH"))

results_df


# Origin site comparing distribution of each feature vs. all other features in foot and gills

features_origin <- rownames(table_data_origin)
results <- lapply(features_origin , function(f) {
  # rows to use for "all other features"
  others <- setdiff(features_origin, f)
  
  feature_vs_rest <- rbind(
    Feature    = table_data_origin[f, , drop = FALSE],
    All_others = colSums(table_data_origin[others, , drop = FALSE])
  )
  
  test <- fisher.test(feature_vs_rest)  # works if there are exactly 2 columns
  
  data.frame(
    feature    = f,
    odds_ratio = if (!is.null(test$estimate)) unname(test$estimate) else NA_real_,
    p_value    = test$p.value,
    row.names  = NULL
  )
})

results_df <- bind_rows(results)
results_df <- results_df %>%
  mutate(p_adj = p.adjust(p_value, method = "BH"))
results_df


# look at dm cpgs compared to background in gills and foot
gill_trans <- dm_bar_plot %>% filter(tissue == "Gills", Type == "Transplant")
gill_origin <- dm_bar_plot %>% filter(tissue == "Gills", Type == "Origin")

foot_trans <- dm_bar_plot %>% filter(tissue == "Foot", Type == "Transplant")
foot_origin <- dm_bar_plot %>% filter(tissue == "Foot", Type == "Origin")


# For each feature, compare to rest - Foot origin
enrichment_results <- foot_origin%>%
  rowwise() %>%
  mutate(
    other_DM = sum(foot_origin$DM_count) - DM_count, #dm found in other features
    other_total = sum(foot_origin$Total) - Total, #other available features
    p_value = fisher.test(matrix(c(DM_count, Total - DM_count, other_DM, other_total - other_DM), nrow = 2))$p.value,
    odds_ratio = fisher.test(matrix(c(DM_count, Total - DM_count, other_DM, other_total - other_DM), nrow = 2))$estimate
  ) %>%
  ungroup() %>% 
  dplyr::select(feature, DM_count, Total, p_value, odds_ratio)


enrichment_results <- enrichment_results %>%
  mutate(p_adj = p.adjust(p_value, method = "BH"))

enrichment_results

# For each feature, compare to rest - Foot transplant
enrichment_results <- foot_trans%>%
  rowwise() %>%
  mutate(
    other_DM = sum(foot_trans$DM_count) - DM_count, #dm found in other features
    other_total = sum(foot_trans$Total) - Total, #other available features
    p_value = fisher.test(matrix(c(DM_count, Total - DM_count, other_DM, other_total - other_DM), nrow = 2))$p.value,
    odds_ratio = fisher.test(matrix(c(DM_count, Total - DM_count, other_DM, other_total - other_DM), nrow = 2))$estimate
  ) %>%
  ungroup() %>% 
  dplyr::select(feature, DM_count, Total, p_value, odds_ratio)


enrichment_results <- enrichment_results %>%
  mutate(p_adj = p.adjust(p_value, method = "BH"))

enrichment_results


# For each feature, compare to rest, gills origin
enrichment_results <- gill_origin%>%
  rowwise() %>%
  mutate(
    other_DM = sum(gill_origin$DM_count) - DM_count, #dm found in other features
    other_total = sum(gill_origin$Total) - Total, #other available features
    p_value = fisher.test(matrix(c(DM_count, Total - DM_count, other_DM, other_total - other_DM), nrow = 2))$p.value,
    odds_ratio = fisher.test(matrix(c(DM_count, Total - DM_count, other_DM, other_total - other_DM), nrow = 2))$estimate
  ) %>%
  ungroup() %>% 
  dplyr::select(feature, DM_count, Total, p_value, odds_ratio)

enrichment_results <- enrichment_results %>%
  mutate(p_adj = p.adjust(p_value, method = "BH"))

enrichment_results


# For each feature, compare to rest, gills transplant
enrichment_results <- gill_trans%>%
  rowwise() %>%
  mutate(
    other_DM = sum(gill_trans$DM_count) - DM_count, #dm found in other features
    other_total = sum(gill_trans$Total) - Total, #other available features
     p_value = fisher.test(matrix(c(DM_count, Total-DM_count, other_DM, other_total-other_DM), nrow = 2))$p.value,
     odds_ratio = fisher.test(matrix(c(DM_count, Total-DM_count, other_DM, other_total-other_DM), nrow = 2))$estimate
  ) %>%
  ungroup() %>% 
  dplyr::select(feature, DM_count, Total, p_value, odds_ratio)

enrichment_results <- enrichment_results %>%
  mutate(p_adj = p.adjust(p_value, method = "BH"))

enrichment_results


# Graphing bar plot of methylation proportion among each feature

# Pivot DM_count, nonDM_count, and Total into long format
library(dplyr)
library(tidyr)

dm_long <- dm_bar_plot %>%
  dplyr::select(feature, tissue, Type, DM_count, nonDM_count, Total) %>%
  pivot_longer(
    cols = c(DM_count, nonDM_count, Total),
    names_to = "Categories",
    values_to = "Count"
  ) %>%
  # Create a new Type_Categories column, only combining for DM_count
  mutate(
    Type_Categories = ifelse(
      Categories == "Total",
      "Total",  # keep as "Total"
      paste(Type, Categories, sep = "_")  # e.g., "Origin_DM_count"
    )
  ) %>%
  # Filter out nonDM if desired
  filter(Categories != "nonDM_count")

dm_long <- dm_long %>%
  mutate(
    Type_Categories = recode(Type_Categories,
                             "Origin_DM_count" = "Origin",
                             "Transplant_DM_count" = "Transplant",
                             "Interacton_DM_count" = "Interaction",
                             "Total" = "Total"))

dm_long <- dm_long %>%
  mutate(
    Type_Categories = factor(Type_Categories, levels = c("Origin", "Transplant", "Interaction", "Total"))
  )

foot<-dm_long %>% 
  filter(tissue=="Foot") 

gill<-dm_long %>% 
  filter(tissue=="Gills") 

p1 <- ggplot(foot, aes(x = Type_Categories, y = Count, fill = feature)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = custom_colors, drop = FALSE) +
  labs(
    title = "",
    y = "Proportion",
    x = "",
    fill = "Feature"
  ) +
  theme_few() +
  theme(
    legend.position = "right",
    axis.text.x = element_text(color = "black", size = 14),  
    axis.text.y = element_text(color = "black", size = 20),
    axis.title = element_text(color = "black", size =20),
    strip.text = element_text(color = "black", size = 20),
    plot.title = element_text(color = "black"),
    axis.ticks = element_line(color = "black"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5)
  )
p1


p2 <- ggplot(gill, aes(x = Type_Categories, y = Count, fill = feature)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = custom_colors, drop = FALSE) +
  labs(
    title = "",
    y = "Proportion",
    x = "",
    fill = "Feature"
  ) +
  theme_few() +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 18),
    legend.title = element_text(size = 20),
    axis.text.x = element_text(color = "black", size = 14),  
    axis.text.y = element_text(color = "black", size = 20),
    axis.title = element_text(color = "black", size =20),
    strip.text = element_text(color = "black", size = 20),
    plot.title = element_text(color = "black"),
    axis.ticks = element_line(color = "black"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5)
  )
p2

# Add margin to ensure y-axis label is visible
p1_clean <- p1 +
  theme(
    plot.title = element_blank(),
    plot.margin = margin(10, 1, 10, 0.2),
    legend.position = "none"# Top, Right, Bottom, Left
  )

p2_clean <- p2 +
  theme(
    plot.title = element_blank(),
    plot.margin = margin(10, 2, 10, 0.2)
  )

# Combine with cowplot
library(cowplot)

plots_combined <- plot_grid(p1_clean, p2_clean, ncol = 2, rel_widths = c(1, 1), align = "hv")

# # Combine plots with smaller relative widths
plots_combined <- plot_grid(
  p1_clean, p2_clean,
  ncol = 2,
  align = "hv",
  axis = "tb" 
)

combined<-ggdraw(ggdraw(clip = "off") ) +
  theme(plot.background = element_rect(fill = "white", colour = NA))+
  draw_plot(plots_combined, 0, 0, 1, 0.95) +
  draw_plot_label(
    label = c("A. Foot", "B. Gills"),
    x = c(0.008, 0.48),
    y = c(0.999, 0.999),
    hjust = 0,
    fontface = "bold",
    size = 20
  )

combined



##### LM to test log2FC differences between tissues ######

##### see if log2FC of DM differ between treatment and tissues

#### load in log2FC data
merged_all_DM_gill<-read_csv("/Users/qcai/Documents/UCSC/Kelley_Lab/mytilus/manuscript/merged_all_DM_gill.csv") %>% mutate(tissue ="Gill")
merged_all_DM_foot<-read_csv("/Users/qcai/Documents/UCSC/Kelley_Lab/mytilus/manuscript/merged_all_DM_foot.csv") %>% mutate(tissue ="foot")

colnames(merged_all_DM_foot)[colnames(merged_all_DM_foot) == "transplant_logFC"] <- "logFC"
colnames(merged_all_DM_gill)[colnames(merged_all_DM_gill) == "transplant_logFC"] <- "logFC"

merged_unique_foot <- merged_all_DM_foot %>%
  distinct(combined, Treat, .keep_all = TRUE)

merged_unique_gill <- merged_all_DM_gill %>%
  distinct(combined, Treat, .keep_all = TRUE)

#### combine log2FC of DM of the two tissue types
lfc_tissues<-rbind(merged_unique_gill, merged_unique_foot)

fit <- lm(transplant_logFC ~ tissue * Treat, data = lfc_tissues)
summary(fit)

emmeans(fit, pairwise ~ Treat | tissue)   # treatment means within each tissue
emmeans(fit, pairwise ~  tissue | Treat) 


fit <- lm(abs(transplant_logFC) ~ tissue * Treat , data = lfc_tissues)
summary(fit)
emmeans(fit, pairwise ~ Treat | tissue)   # treatment means within each tissue
emmeans(fit, pairwise ~  tissue | Treat) 
